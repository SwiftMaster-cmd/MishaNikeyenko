<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Guest Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../css/guest-portal.css" />
</head>
<body>

  <header id="leadHeader">
    <button id="newLeadBtn">+ New Lead</button>
    <span id="leadIdDisplay">Lead ID: --</span>
    <progress id="progressBar" max="100" value="0"></progress>
    <span id="progressLabel">0%</span>
  </header>

  <main id="guestApp">
    <section id="step1Form">
      <h2>Step 1: Customer Info</h2>
      <label>Customer Name
        <input id="custName" type="text" autocomplete="off" />
      </label>
      <label>Customer Phone
        <input id="custPhone" type="tel" autocomplete="off" />
      </label>
    </section>

    <section id="step2Form">
      <h2>Step 2: Evaluate Needs</h2>
      <div id="step2Fields">
        <!-- Your gpQuestions inputs rendered here -->
      </div>
    </section>

    <section id="step3Form">
      <h2>Step 3: Proposed Solution</h2>
      <textarea id="solutionText" rows="6"></textarea>
    </section>
  </main>

  <script type="module">
   import { GuestFormApp } from '../js/gp/gp-app.js';
import { firebaseOnAuthStateChanged, getCurrentUserUid, createNewLead } from '../js/gp/gp-firebase.js';

    // Assume gpQuestions is loaded separately or inline as global

    const leadIdDisplay = document.getElementById("leadIdDisplay");
    const progressBar = document.getElementById("progressBar");
    const progressLabel = document.getElementById("progressLabel");
    const newLeadBtn = document.getElementById("newLeadBtn");

    const app = new GuestFormApp({
      onLeadChange: (id) => {
        leadIdDisplay.textContent = id ? `Lead ID: ${id}` : "Lead ID: --";
      },
      onProgressUpdate: (pct) => {
        progressBar.value = pct;
        progressLabel.textContent = pct + "%";
      }
    });

    firebaseOnAuthStateChanged(async user => {
      if (!user) {
        alert("Please sign in to continue.");
        // handle sign-in UI here
        return;
      }
      const lastKey = localStorage.getItem("last_guestinfo_key");
      if (lastKey) {
        await app.loadGuest(lastKey);
      }
    });

    newLeadBtn.addEventListener("click", async () => {
      const uid = getCurrentUserUid();
      const newKey = await createNewLead(uid);
      localStorage.setItem("last_guestinfo_key", newKey);
      await app.loadGuest(newKey);
    });
  </script>

</body>
</html>